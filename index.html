<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaza Crisis Action: One‑Minute MP Letter</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .step-card { display: none; }
        .step-card.active { display: block; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Custom loading spinner */
        .loader { width: 48px; height: 48px; border: 5px solid #e2e8f0; border-bottom-color: #009736; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Colour variables for easy theme overrides */
        .theme-bg-red { background-color: #EE2A35; }
        .theme-text-red { color: #EE2A35; }
        .theme-bg-green { background-color: #009736; }
        .theme-text-green { color: #009736; }
        .theme-bg-black { background-color: #000000; }
        .theme-text-black { color: #000000; }
        .hover-bg-red-dark:hover { background-color: #c81e29; }
        .hover-bg-green-dark:hover { background-color: #007a2c; }
        .text-outline-white { text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col items-center">
    <!-- Full screen hero section -->
    <header class="h-screen w-full flex flex-col text-white p-8 md:p-12 relative"
        style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/Displaced_children_sit_on_the_rubble_of_their_destroyed_home_in_Nuseirat_camp,_Gaza_Strip.jpg/1280px-Displaced_children_sit_on_the_rubble_of_their_destroyed_home_in_Nuseirat_camp,_Gaza_Strip.jpg'); background-size: cover; background-position: center;">
        <!-- Dark gradient overlay -->
        <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-transparent to-black/80"></div>
        <div class="relative z-10 w-full flex flex-col flex-grow text-center">
            <!-- Headline and description -->
            <div>
                <h1 class="text-5xl md:text-7xl font-extrabold leading-tight">
                    <span class="theme-text-red">Gaza</span> <span class="theme-text-black text-outline-white">can’t</span> <span class="theme-text-green">wait</span><span class="text-white">.</span>
                </h1>
                <p class="text-lg md:text-2xl mt-4 max-w-3xl mx-auto text-white font-semibold">
                    Write an effective letter to your MP in under 60 seconds and demand urgent action.
                </p>
            </div>
            <div class="flex-grow"></div>
            <!-- Statistics and call to action -->
            <div class="w-full max-w-4xl mx-auto">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-white mb-6">
                    <div class="bg-black/50 p-2 rounded-lg flex flex-col justify-center items-center h-24">
                        <p class="text-3xl font-bold">52,064</p>
                        <p class="text-xs uppercase tracking-wider mt-1">Total Fatalities</p>
                    </div>
                    <div class="bg-black/50 p-2 rounded-lg flex flex-col justify-center items-center h-24">
                        <p class="text-3xl font-bold">17,000+</p>
                        <p class="text-xs uppercase tracking-wider mt-1">Child Fatalities</p>
                    </div>
                    <div class="bg-black/50 p-2 rounded-lg flex flex-col justify-center items-center h-24">
                        <p class="text-3xl font-bold">121,700</p>
                        <p class="text-xs uppercase tracking-wider mt-1">Total Injuries</p>
                    </div>
                    <div class="bg-black/50 p-2 rounded-lg flex flex-col justify-center items-center h-24">
                        <p class="text-3xl font-bold">470,000</p>
                        <p class="text-xs uppercase tracking-wider mt-1">Facing Famine</p>
                    </div>
                </div>
                <p class="text-xs text-gray-300 mb-6">Source: UN OCHA, British Red Cross (July 2025)</p>
                <a href="#form-section" class="inline-block theme-bg-red text-white font-bold py-4 px-10 rounded-lg text-lg hover-bg-red-dark transition-colors shadow-lg">
                    Start Your Letter
                </a>
            </div>
        </div>
    </header>

    <!-- Main form container -->
    <div id="form-section" class="w-full max-w-lg mx-auto p-4">
        <!-- Brief story introduction -->
        <section class="text-center my-12 px-4">
            <h2 class="text-2xl font-bold mb-2">Your Voice is a Lifeline.</h2>
            <p class="text-gray-600 max-w-xl mx-auto">
                Writing to your MP is one of the most effective ways to demand change. When enough constituents speak up, MPs are compelled to act. Your letter joins a growing chorus that cannot be ignored.
            </p>
        </section>
        <!-- Progress indicator -->
        <div class="px-6 mb-4">
            <p class="text-center text-sm text-gray-500 mb-2">Just 1 minute to make a difference</p>
            <div class="flex items-center justify-between">
                <div class="flex-1 text-center">
                    <div id="progress-step-1" class="w-8 h-8 mx-auto rounded-full theme-bg-red text-white flex items-center justify-center font-bold">1</div>
                    <p class="text-xs mt-1">Your Details</p>
                </div>
                <div class="flex-1 border-t-2 border-gray-200"></div>
                <div class="flex-1 text-center">
                    <div id="progress-step-2" class="w-8 h-8 mx-auto rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold">2</div>
                    <p class="text-xs mt-1">Your Message</p>
                </div>
                <div class="flex-1 border-t-2 border-gray-200"></div>
                <div class="flex-1 text-center">
                    <div id="progress-step-3" class="w-8 h-8 mx-auto rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold">3</div>
                    <p class="text-xs mt-1">Send Letter</p>
                </div>
            </div>
        </div>
        <!-- Card wrapper for each step -->
        <main id="app-container" class="bg-white rounded-xl shadow-lg transition-all duration-500">
            <!-- Step 1: user details form -->
            <div id="step-1" class="step-card active p-6 md:p-8 fade-in">
                <h2 class="text-2xl font-semibold mb-6">First, let’s find your MP.</h2>
                <div class="space-y-4">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Your Full Name</label>
                        <input type="text" id="fullName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="e.g., Jane Doe">
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Your Street Address</label>
                        <input type="text" id="address" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="e.g., 10 Downing Street">
                    </div>
                    <div>
                        <label for="postcode" class="block text-sm font-medium text-gray-700 mb-1">Your Postcode</label>
                        <input type="text" id="postcode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="e.g., W6 0HU">
                    </div>
                </div>
                <div id="step-1-error" class="text-red-500 text-sm mt-4 hidden"></div>
                <div class="mt-8">
                    <button id="find-mp-button" onclick="findMyMp()" class="w-full theme-bg-red text-white font-bold py-3 px-4 rounded-lg hover-bg-red-dark transition-colors shadow-md flex items-center justify-center">
                        Find My MP
                    </button>
                </div>
            </div>
            <!-- Step 2: message and demand selection -->
            <div id="step-2" class="step-card p-6 md:p-8 fade-in">
                <h2 class="text-2xl font-semibold mb-2">Your MP found – now tell them.</h2>
                <div id="mp-info-container" class="bg-gray-50 rounded-lg p-4 flex items-center space-x-4 mb-6"></div>
                <h3 class="text-xl font-semibold mb-4">What do you want to say?</h3>
                <p class="text-gray-600 mb-4">
                    Explain why this issue matters to you personally and what you want your MP to know about your feelings on the crisis.
                </p>
                <textarea id="user-message" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="e.g., As a parent, I am heartbroken by the images of children suffering. I feel our country is not doing enough..."></textarea>
                <h3 class="text-xl font-semibold mb-4 mt-6">What action should be taken?</h3>
                <p class="text-gray-600 mb-4">Select the specific demands you want your MP to support.</p>
                <div id="demands-container" class="space-y-3 border-t border-b py-4"></div>
                <!-- Hidden custom demand input shown when 'Other' is checked -->
                <div id="other-demand-container" class="mt-4 hidden">
                    <label for="other-demand-text" class="block text-sm font-medium text-gray-700 mb-1">Your custom demand:</label>
                    <input type="text" id="other-demand-text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="e.g., Demand a special session on this crisis">
                </div>
                <div id="step-2-error" class="text-red-500 text-sm mt-4 hidden"></div>
                <div class="mt-8">
                    <button id="generate-letter-button" onclick="generateLetter()" class="w-full theme-bg-red text-white font-bold py-3 px-4 rounded-lg hover-bg-red-dark transition-colors shadow-md flex items-center justify-center">
                        Send My MP a Letter Now
                    </button>
                </div>
            </div>
            <!-- Step 3: loading screen -->
            <div id="step-3" class="step-card p-6 md:p-8 text-center fade-in">
                <div class="flex flex-col items-center justify-center h-64">
                    <div class="loader"></div>
                    <h2 id="loading-text" class="text-xl font-semibold text-gray-700 mt-6"></h2>
                </div>
            </div>
            <!-- Step 4: final letter -->
            <div id="step-4" class="step-card p-6 md:p-8 fade-in">
                <h2 class="text-2xl font-semibold mb-4 text-center">Your letter is ready.</h2>
                <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">MP Contact Details:</h3>
                    <div id="mp-contact-final" class="flex items-center justify-between"></div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Generated Letter:</h3>
                    <div id="final-letter-text" class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed"></div>
                </div>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="sendEmail()" class="w-full theme-bg-green text-white font-bold py-3 px-4 rounded-lg hover-bg-green-dark transition-colors shadow-md flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        Send via Email
                    </button>
                    <button onclick="copyLetterAndContinue()" class="w-full theme-bg-black text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors">
                        Copy Full Letter
                    </button>
                </div>
            </div>
            <!-- Step 5: thank you + further actions -->
            <div id="step-5" class="step-card p-6 md:p-8 text-center fade-in">
                <h2 class="text-2xl font-semibold mb-4 theme-text-green">Thank You for Taking Action.</h2>
                <p class="text-gray-600 mb-6">
                    Your voice is a powerful tool for change. By contacting your MP, you have taken a meaningful step in demanding justice and humanity for the people of Gaza.
                </p>
                <div class="bg-gray-50 rounded-lg p-4 mb-8">
                    <p class="text-lg font-bold">Help us reach <span class="theme-text-red">10,000</span> letters!</p>
                    <p class="text-sm text-gray-600 mt-1">Letters sent so far: <span id="letter-counter" class="font-bold">1,234</span></p>
                    <h3 class="font-semibold text-gray-800 mt-4 mb-3">Share this tool and amplify our impact:</h3>
                    <div class="flex justify-center space-x-4">
                        <button onclick="share('twitter')" class="w-12 h-12 bg-gray-800 text-white rounded-full flex items-center justify-center hover:bg-black transition-colors">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                            </svg>
                        </button>
                        <button onclick="share('facebook')" class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700 transition-colors">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" />
                            </svg>
                        </button>
                        <button onclick="share('whatsapp')" class="w-12 h-12 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-colors">
                            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                                <!-- Corrected negative value in the path data (removed stray space) -->
                                <path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2 22l5.25-1.38c1.45.79 3.08 1.21 4.79 1.21 5.46 0 9.91-4.45 9.91-9.91S17.5 2 12.04 2zm0 18.15c-1.48 0-2.93-.4-4.2-1.15l-.3-.18-3.12.82.83-3.04-.2-.31c-.82-1.31-1.26-2.83-1.26-4.38 0-4.54 3.7-8.24 8.24-8.24 2.2 0 4.27.86 5.82 2.42 1.56 1.56 2.42 3.62 2.42 5.82-0.01 4.54-3.71 8.24-8.25 8.24zm4.52-6.13c-.25-.12-1.47-.72-1.7-.81-.23-.09-.39-.12-.56.12-.17.25-.64.81-.79.97-.14.17-.29.19-.54.06-.25-.12-1.07-.39-2.04-1.26-.75-.67-1.26-1.5-1.41-1.76-.15-.25-.02-.38.11-.51.11-.11.25-.29.37-.43.13-.14.17-.25.25-.41.08-.17.04-.31-.02-.43-.06-.12-.56-1.34-.76-1.84-.2-.48-.41-.42-.56-.42-.14 0-.3 0-.46 0-.16 0-.42.06-.64.31-.22.25-.86.85-.86 2.07 0 1.22.88 2.4 1 2.56.12.17 1.76 2.67 4.25 3.73.59.25 1.05.41 1.41.52.59.19 1.13.16 1.56.1.48-.07 1.47-.6 1.67-1.18.21-.58.21-1.07.15-1.18-.07-.12-.23-.19-.48-.31z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <h3 class="font-semibold text-gray-800 mb-4">Further Actions You Can Take</h3>
                <div class="space-y-4 text-left">
                    <a href="https://www.map.org.uk/donate/donation-details/474" target="_blank" rel="noopener" class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <p class="font-semibold theme-text-red">Donate to Medical Aid for Palestinians (MAP)</p>
                        <p class="text-sm text-gray-600">Provide direct medical aid to those affected by the crisis.</p>
                    </a>
                    <a href="https://bdsmovement.net/get-involved/what-to-boycott" target="_blank" rel="noopener" class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <p class="font-semibold theme-text-red">Support the BDS Movement</p>
                        <p class="text-sm text-gray-600">Learn about and participate in the Boycott, Divestment, Sanctions movement.</p>
                    </a>
                    <a href="https://www.psc.org.uk/" target="_blank" rel="noopener" class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <p class="font-semibold theme-text-red">Join Local Solidarity Campaigns</p>
                        <p class="text-sm text-gray-600">Find and join local protests and events with the Palestine Solidarity Campaign.</p>
                    </a>
                </div>
                <div class="mt-8">
                    <button onclick="startOver()" class="w-full theme-bg-black text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors">Start a New Letter</button>
                </div>
            </div>
        </main>
        <!-- Site footer -->
        <footer class="text-center my-8 text-xs text-gray-400 px-4">
            <div class="flex justify-center items-center space-x-4 mb-4">
                <p class="font-bold">Trusted Data Sources:</p>
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span>Official UK Parliament Data</span>
                </div>
            </div>
            <p class="mb-2">Privacy Assurance: Your personal data is only used to generate this letter and is not stored or shared.</p>
            <p class="mt-1">Contains Parliamentary information licensed under the Open Parliament Licence v3.0.</p>
        </footer>
    </div>
    <!-- Application logic -->
    <script>
        // Current form step and state storage
        let currentStep = 1;
        const appState = {
            fullName: '',
            address: '',
            postcode: '',
            mpData: null,
            userMessage: '',
            selectedDemands: [],
            finalLetter: '',
        };
        // The demands presented to users
        const demandsList = [
            "Call for an immediate and permanent ceasefire in Gaza.",
            "Demand the UK Government suspend all arms sales to Israel.",
            "Advocate for the UK to officially recognise the State of Palestine.",
            "Urge the government to increase humanitarian aid to Gaza.",
            "Support international legal action against potential war crimes.",
            "Press for the protection of journalists and aid workers in the region.",
            "Demand sanctions on Israeli officials responsible for violations of international law.",
            "Call for an end to the blockade and siege of Gaza.",
            "Insist on the UK's commitment to a two‑state solution based on 1967 borders.",
            "Oppose the forced displacement of Palestinians from their homes."
        ];
        // Populate the checkboxes once the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const demandsContainer = document.getElementById('demands-container');
            let html = '';
            demandsList.forEach((demand, index) => {
                html += `
                    <label for="demand-${index}" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" id="demand-${index}" value="${demand}" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500" />
                        <span class="ml-3 text-sm text-gray-700">${demand}</span>
                    </label>
                `;
            });
            html += `
                <label for="demand-other" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" id="demand-other" value="Other" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500" />
                    <span class="ml-3 text-sm text-gray-700">Other (please specify)</span>
                </label>
            `;
            demandsContainer.innerHTML = html;
            // Toggle the custom demand input on 'Other' check
            document.getElementById('demand-other').addEventListener('change', (e) => {
                const otherContainer = document.getElementById('other-demand-container');
                otherContainer.classList.toggle('hidden', !e.target.checked);
            });
        });
        // Update the progress bar to reflect the current step
        function updateProgress(step) {
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`progress-step-${i}`);
                if (i <= step) {
                    stepEl.classList.remove('bg-gray-200', 'text-gray-500');
                    stepEl.classList.add('theme-bg-red', 'text-white');
                } else {
                    stepEl.classList.add('bg-gray-200', 'text-gray-500');
                    stepEl.classList.remove('theme-bg-red', 'text-white');
                }
            }
        }
        // Navigate between different steps
        function goToStep(step) {
            // When leaving step 1 capture the user's details
            if (currentStep === 1 && step > 1) {
                appState.fullName = document.getElementById('fullName').value.trim();
                appState.address = document.getElementById('address').value.trim();
                appState.postcode = document.getElementById('postcode').value.trim();
            }
            currentStep = step;
            const formSteps = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
            formSteps.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });
            const nextStepElement = document.getElementById(`step-${step}`);
            if (nextStepElement) {
                nextStepElement.classList.add('active', 'fade-in');
            }
            if (step === 1) updateProgress(1);
            if (step === 2) updateProgress(2);
            if (step >= 4) updateProgress(3);
        }
        // Show the loading screen with a specific message
        function showLoading(text) {
            document.getElementById('loading-text').innerText = text;
            goToStep(3);
        }
        // Utility to show error messages on a given step
        function showError(step, message) {
            const errorEl = document.getElementById(`step-${step}-error`);
            if (errorEl) {
                errorEl.innerText = message;
                errorEl.classList.remove('hidden');
            }
        }
        // Hide error messages for a step
        function hideError(step) {
            const errorEl = document.getElementById(`step-${step}-error`);
            if (errorEl) {
                errorEl.classList.add('hidden');
            }
        }
        // Fetch MP details from the UK Parliament API
        async function findMpDetails(postcode) {
            const cleanPostcode = postcode.trim().toUpperCase().replace(/\s+/g, '');
            const searchResp = await fetch(
                `https://members-api.parliament.uk/api/Location/Constituency/Search?searchText=${encodeURIComponent(cleanPostcode)}&skip=0&take=1`
            );
            if (!searchResp.ok) throw new Error('Failed to look up constituency from postcode.');
            const searchData = await searchResp.json();
            const item = searchData.items && searchData.items[0];
            if (!item) throw new Error('No constituency found for that postcode.');
            const mp = item.value.currentRepresentation?.member?.value;
            if (!mp) throw new Error('This seat may currently be vacant.');
            const memberId = mp.id;
            const contactResp = await fetch(
                `https://members-api.parliament.uk/api/Members/${memberId}/Contact`
            );
            if (!contactResp.ok) throw new Error('Could not retrieve MP contact details.');
            const contactData = await contactResp.json();
            let email = null;
            if (contactData.value && Array.isArray(contactData.value)) {
                const office = contactData.value.find(entry => entry.typeId === 1);
                if (office) email = office.email || null;
            }
            if (!email) throw new Error('An email address for this MP could not be found.');
            const thumbnailUrl = mp.thumbnailUrl
                ? `https://members-api.parliament.uk${mp.thumbnailUrl}`
                : 'https://placehold.co/64x64/e0e7ff/3730a3?text=MP';
            return {
                name: mp.nameFullTitle || mp.nameDisplayAs,
                constituency: item.value.name,
                email,
                photoUrl: thumbnailUrl,
            };
        }
        // Handler for step 1 button
        async function findMyMp() {
            hideError(1);
            const fullName = document.getElementById('fullName').value.trim();
            const address = document.getElementById('address').value.trim();
            const postcode = document.getElementById('postcode').value.trim();
            if (!fullName || !postcode || !address) {
                showError(1, 'Please fill in all fields.');
                return;
            }
            showLoading('Finding your MP...');
            try {
                const mpDetails = await findMpDetails(postcode);
                appState.mpData = mpDetails;
                const mpInfoContainer = document.getElementById('mp-info-container');
                mpInfoContainer.innerHTML = `
                    <img src="${mpDetails.photoUrl}" alt="Photo of ${mpDetails.name}"
                        class="w-16 h-16 rounded-full object-cover border-2 border-white shadow-sm" onerror="this.onerror=null; this.src='https://placehold.co/64x64/e0e7ff/3730a3?text=MP';" />
                    <div>
                        <p class="font-bold text-lg text-gray-900">${mpDetails.name}</p>
                        <p class="text-sm text-gray-600">${mpDetails.constituency}</p>
                    </div>
                `;
                goToStep(2);
            } catch (error) {
                console.error('Error finding MP:', error);
                goToStep(1);
                showError(1, error.message);
            }
        }
        // Build the full prompt for the AI
        function buildPrompt() {
            const currentDate = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            const fullAddress = `${appState.address}\n${appState.postcode}`;
            const demandsText = appState.selectedDemands.map(d => `- ${d}`).join('\n');
            return `
                You are an expert assistant specializing in drafting formal, respectful, and impactful letters to UK Members of Parliament about the crisis in Gaza.
                Your task is to rewrite the user's raw notes into a professional letter, incorporating a specific list of demands. The tone should be firm, deeply concerned, and reflect the gravity of a humanitarian crisis, drawing inspiration from the provided examples.
                **Crucially, you must introduce significant variability in sentence structure, phrasing, and vocabulary to ensure that letters sent to the same MP are not identical.** Use the reference letters for tonal inspiration only, not for direct copying of structure or language. Do not include a "Subject:" line or any markdown formatting like asterisks.
                
                **Data to Use:**
                - MP's Name: ${appState.mpData.name}
                - User's Full Name: ${appState.fullName}
                - User's Full Address:\n${fullAddress}
                - Current Date: ${currentDate}
                - User's Context Notes: "${appState.userMessage}"
                - User's Selected Demands:\n${demandsText}
                Now, generate the complete letter.
            `;
        }
        // Handler for step 2 button
        async function generateLetter() {
            hideError(2);
            appState.userMessage = document.getElementById('user-message').value.trim();
            appState.selectedDemands = [];
            const demandCheckboxes = document.querySelectorAll('#demands-container input[type="checkbox"]:checked');
            demandCheckboxes.forEach(checkbox => {
                if (checkbox.id === 'demand-other') {
                    const otherText = document.getElementById('other-demand-text').value.trim();
                    if (otherText) {
                        appState.selectedDemands.push(otherText);
                    }
                } else {
                    appState.selectedDemands.push(checkbox.value);
                }
            });
            if (!appState.userMessage) {
                showError(2, 'Please write down the main points of your concern.');
                return;
            }
            if (appState.selectedDemands.length === 0) {
                showError(2, 'Please select at least one demand to include in the letter.');
                return;
            }
            showLoading('AI is drafting your letter...');
            const prompt = buildPrompt();
            try {
                // Send the prompt to our Netlify serverless function. The API key is stored
                // server‑side, so there is no need to expose it in the client. The function
                // endpoint will forward the request to the Gemini API and return the
                // response JSON. See netlify/functions/generate-letter.js for details.
                const response = await fetch('/.netlify/functions/generate-letter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt }),
                });
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                const result = await response.json();
                if (
                    result.candidates &&
                    result.candidates.length > 0 &&
                    result.candidates[0].content.parts.length > 0
                ) {
                    appState.finalLetter = result.candidates[0].content.parts[0].text;
                    displayFinalLetter();
                } else {
                    throw new Error('The AI was unable to generate a letter. The response was empty.');
                }
            } catch (error) {
                console.error('AI generation error:', error);
                goToStep(2);
                showError(2, 'Sorry, there was a problem generating the letter. Please try again.');
            }
        }
        // Display the letter and MP contact details on step 4
        function displayFinalLetter() {
            const mpContactFinal = document.getElementById('mp-contact-final');
            mpContactFinal.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${appState.mpData.name}</p>
                    <p class="text-sm text-gray-600" id="mp-email">${appState.mpData.email}</p>
                </div>
                <button onclick="copyEmailAndShowFeedback('mp-email', this)" class="text-sm bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-md hover:bg-gray-300">Copy Email</button>
            `;
            document.getElementById('final-letter-text').innerText = appState.finalLetter;
            goToStep(4);
        }
        // Compose and open a mailto link, then show thank you page
        function sendEmail() {
            const subject = 'Urgent Constituent Matter Regarding Gaza';
            const body = appState.finalLetter;
            const mailtoLink = `mailto:${appState.mpData.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            goToStep(5);
        }
        // Fallback copy method for older browsers (avoids needing clipboard API)
        function copyTextWithFallback(text) {
            return new Promise((resolve, reject) => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) resolve();
                    else reject(new Error('Fallback copy command was unsuccessful.'));
                } catch (err) {
                    reject(err);
                }
                document.body.removeChild(textArea);
            });
        }
        // Copy the generated letter and proceed to thank-you step
        function copyLetterAndContinue() {
            const textToCopy = document.getElementById('final-letter-text').innerText;
            copyTextWithFallback(textToCopy).then(() => {
                goToStep(5);
            }).catch(err => {
                console.error('Failed to copy letter: ', err);
                alert('Could not copy the letter to your clipboard.');
            });
        }
        // Copy the MP's email and provide visual feedback
        function copyEmailAndShowFeedback(elementId, buttonElement) {
            const textToCopy = document.getElementById(elementId).innerText;
            copyTextWithFallback(textToCopy).then(() => {
                const originalText = buttonElement.innerText;
                buttonElement.innerText = 'Copied!';
                buttonElement.classList.add('bg-green-200', 'text-green-800');
                setTimeout(() => {
                    buttonElement.innerText = originalText;
                    buttonElement.classList.remove('bg-green-200', 'text-green-800');
                }, 2000);
            }).catch(err => console.error('Failed to copy email: ', err));
        }
        // Social sharing handler; update the siteUrl when deploying to a different domain
        function share(platform) {
            const siteUrl = 'https://gaza-crisis-action.netlify.app';
            const text = `I just used the Gaza Crisis Action tool to write to my MP and demand a ceasefire. It took less than a minute. Add your voice now: ${siteUrl}`;
            let shareUrl = '';
            if (platform === 'twitter') {
                shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            } else if (platform === 'facebook') {
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(siteUrl)}`;
            } else if (platform === 'whatsapp') {
                shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
            }
            if (shareUrl) {
                window.open(shareUrl, '_blank');
            }
        }
        // Reset the form and state and return to step 1
        function startOver() {
            Object.assign(appState, {
                fullName: '',
                address: '',
                postcode: '',
                mpData: null,
                userMessage: '',
                selectedDemands: [],
                finalLetter: '',
            });
            document.getElementById('fullName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('postcode').value = '';
            document.getElementById('user-message').value = '';
            document.querySelectorAll('#demands-container input[type="checkbox"]').forEach(cb => cb.checked = false);
            goToStep(1);
            updateProgress(1);
            document.getElementById('form-section').scrollIntoView();
        }
        // Expose functions to the global scope so inline handlers can call them
        window.goToStep = goToStep;
        window.findMyMp = findMyMp;
        window.generateLetter = generateLetter;
        window.sendEmail = sendEmail;
        window.copyLetterAndContinue = copyLetterAndContinue;
        window.share = share;
        window.startOver = startOver;
        window.copyEmailAndShowFeedback = copyEmailAndShowFeedback;
    </script>
</body>
</html>
